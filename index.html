<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1.0" >
    <title>Comprehensive Sales Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" >
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin >
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet" >
    <style>
        /* CSS Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --dark-bg: #0d0c1d;
            --glass-bg: rgba(26, 28, 49, 0.65);
            --neon-cyan: #00f2fe;
            --neon-magenta: #ff00f2;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0b0;
            --color-positive: #34d399;
            --color-negative: #ff4757;
            --border-glow: 0 0 12px rgba(0, 242, 254, 0.3), 0 0 2px rgba(0, 242, 254, 0.8) inset;
        }
        body {
            font-family: 'Poppins', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .glass-panel {
            background: var(--glass-bg); border-radius: 20px; padding: 24px;
            margin-bottom: 22px; border: 1px solid rgba(0, 242, 254, 0.2);
            box-shadow: var(--border-glow); backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .topbar { display: flex; flex-wrap: wrap; gap: 14px; align-items: center; justify-content: space-between; }
        .topbar h1 {
            font-size: 2rem; font-weight: 800;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .controls { display: flex; flex-direction: column; gap: 12px; }
        .control-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .btn {
            padding: 10px 18px; border: 1px solid var(--neon-cyan); border-radius: 999px;
            color: var(--neon-cyan); font-weight: 600; cursor: pointer; background: transparent;
            transition: all 0.3s ease; box-shadow: 0 0 8px rgba(0, 242, 254, 0.4);
        }
        .btn:hover { background: rgba(0, 242, 254, 0.1); color: white; box-shadow: 0 0 15px rgba(0, 242, 254, 0.7); transform: translateY(-2px); }
        #geminiBtn { background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta)); color: white; border: none; font-weight: 700; }
        #geminiBtn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 0 20px rgba(255, 0, 242, 0.5); }
        
        input[type="date"], input[type="checkbox"], textarea { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: var(--text-primary); padding: 6px 10px; border-radius: 8px; color-scheme: dark; }
        textarea { width: 100%; min-height: 400px; font-family: monospace; font-size: 14px; line-height: 1.6; color: #00f2fe; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 22px;}
        .stat-card { background: var(--glass-bg); border-radius: 12px; padding: 18px; text-align: center; border: 1px solid rgba(0, 242, 254, 0.15); transition: transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: var(--border-glow); }
        .stat-number { font-size: 2.2em; font-weight: 800; background: linear-gradient(135deg, var(--neon-cyan) 0%, var(--neon-magenta) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .stat-label { color: var(--text-secondary); font-size: 0.9em; margin-top: 6px; }
        
        .chart-title { font-size: 1.2em; color: var(--text-primary); margin-bottom: 16px; font-weight: 700; }
        .chart-wrapper-large { height: 400px; }
        
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        thead { border-bottom: 2px solid var(--neon-cyan); }
        th, td { padding: 12px; text-align: left; font-size: 0.85em; }
        tbody tr { border-bottom: 1px solid rgba(255,255,255,0.1); transition: 0.3s; }
        tbody tr.clickable-row:hover { background: rgba(0, 242, 254, 0.1); cursor: pointer; }
        
        .revenue-cell { font-weight: 600; color: #34d399; }
        .context-cell { color: var(--text-secondary); font-style: italic; font-size: 0.9em; }
        .context-label { display: block; font-size: 0.75rem; color: var(--neon-cyan); opacity: 0.8; margin-bottom: 2px; }
        
        /* Modal Design */
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .modal-overlay.show { display: flex; }
        .modal-content { width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto; position: relative; border: 1px solid var(--neon-cyan); }
        
        .type-section { margin-bottom: 30px; border-left: 4px solid var(--neon-cyan); padding-left: 15px; background: rgba(0, 242, 254, 0.05); border-radius: 0 10px 10px 0; padding: 15px; }
        .type-title { font-size: 1.1em; font-weight: 700; margin-bottom: 12px; color: var(--neon-cyan); display: flex; align-items: center; gap: 10px; }
        .type-badge { background: var(--neon-cyan); color: #000; padding: 2px 10px; border-radius: 5px; font-size: 0.7em; }
        
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.show { display: block; }
        .spinner { border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid var(--neon-cyan); border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar glass-panel">
            <h1>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏™‡∏≤‡∏Ç‡∏≤ Choc</h1>
            <div class="controls">
                <div class="control-row">
                    <label>Start: <input type="date" id="startDate" ></label>
                    <label>End: <input type="date" id="endDate" ></label>
                    <button class="btn" id="refreshBtn">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>
        </div>

        <div class="glass-panel">
            <div class="section-header"><h2>‚ú® ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏î‡πâ‡∏ß‡∏¢ AI</h2></div>
            <button class="btn" id="geminiBtn">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ Gemini</button>
            <p style="font-size: 0.8em; color: var(--text-secondary); margin-top: 10px;">*‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Gemini</p>
        </div>

        <div class="section-header"><h2>üèÜ Performance Overview</h2></div>
        <div class="stats-grid" id="mainStatsGrid"></div>

        <div class="section-header"><h2>üí∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (Revenue Breakdown)</h2></div>
        <div class="stats-grid" id="revenueStatsGrid"></div>

        <div class="glass-panel" style="overflow-x: auto;">
            <h2 class="chart-title">üì° ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h2>
            <table id="channelSummaryTable">
                <thead>
                    <tr>
                        <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏• P1</th>
                        <th>P2 Leads</th>
                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏• UP P2</th>
                        <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th>
                    </tr>
                </thead>
                <tbody id="channelTableBody"></tbody>
            </table>
        </div>

        <div class="section-header"><h2>üìã Category Performance (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏¥‡∏•)</h2></div>
        <div class="glass-panel">
            <div class="chart-wrapper-large"><canvas id="revenueBarChart"></canvas></div>
        </div>

        <div class="glass-panel" style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Rank</th><th>Category</th><th>P1 Bills</th><th>UP P1 Bills</th><th>UP P2 Bills</th><th>Total Revenue</th>
                    </tr>
                </thead>
                <tbody id="categoryTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal for Detailed List -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content glass-panel">
            <div id="modalTitle" style="font-size:1.5em; font-weight:800; margin-bottom:20px; color:var(--neon-cyan); border-bottom:2px solid rgba(0,242,254,0.3); padding-bottom:10px; display: flex; justify-content: space-between; align-items: center;">
                <span>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
                <button class="btn" onclick="document.getElementById('detailsModal').classList.remove('show')" style="padding: 5px 15px;">X</button>
            </div>
            <div id="modalBody" class="modal-body">
                <!-- Content injected here -->
            </div>
            <div style="text-align:right; margin-top:20px;">
                <button class="btn" onclick="document.getElementById('detailsModal').classList.remove('show')">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
        </div>
    </div>

    <div class="loading" id="loading"><div class="spinner"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>

    <script>
    const CONFIG = {
        SHEET_ID: '1F2bTvP1ySUT1q6fzRPQu7UpKNW_ze8GtKkd2rmRUjkI',
        SHEET_NAME_SUMMARY: 'SUM',
        COLUMN_NAMES: {
            CUSTOMER: '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', DATE: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', PHONE: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠',
            CATEGORIES: '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', CHANNEL: '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á', INTEREST: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à',
            IS_NEW: '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà', P1: 'P1', P2: 'P2', UP_P1: '‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏û P1', UP_P2: '‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏û P2'
        }
    };

    let latestData = {};
    let allDataCache = [];
    let charts = {};

    function gvizUrl(sheetName) { return `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&t=${Date.now()}`; }
    function toNumber(val) { if (!val) return 0; return parseFloat(String(val).replace(/[‡∏ø,]/g, '')) || 0; }
    function parseGvizDate(gvizDate) { if (!gvizDate) return null; const match = gvizDate.match(/Date\((\d+),(\d+),(\d+)/); return match ? new Date(match[1], match[2], match[3]) : new Date(gvizDate); }
    function formatDate(date) { return date ? date.toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: '2-digit' }) : '-'; }

    async function fetchData() {
        try {
            const res = await fetch(gvizUrl(CONFIG.SHEET_NAME_SUMMARY));
            const text = await res.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            const cols = json.table.cols.map(c => (c.label || '').trim());
            allDataCache = json.table.rows.map(r => {
                let obj = {};
                cols.forEach((col, i) => { if(col) obj[col] = r.c[i] ? r.c[i].v : null; });
                return obj;
            });
        } catch (e) {
            console.error("Fetch Error:", e);
        }
    }

    function processPeriod(rows) {
        const C = CONFIG.COLUMN_NAMES;
        let summary = { totalBills: 0, totalRevenue: 0, p1Revenue: 0, upp1Revenue: 0, upp2Revenue: 0, totalCustomers: 0 };
        let channels = {};
        let categories = {};

        rows.forEach(row => {
            const p1 = toNumber(row[C.P1]), up1 = toNumber(row[C.UP_P1]), up2 = toNumber(row[C.UP_P2]);
            const rev = p1 + up1 + up2;
            
            if (rev > 0 || row[C.P2]) {
                summary.totalRevenue += rev;
                summary.p1Revenue += p1;
                summary.upp1Revenue += up1;
                summary.upp2Revenue += up2;
                if (rev > 0) summary.totalBills++;
                if (p1 > 0 || up2 > 0) summary.totalCustomers++;

                const ch = row[C.CHANNEL] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                if (!channels[ch]) channels[ch] = { p1: 0, p2: 0, upP2: 0, revenue: 0 };
                if (p1 > 0 && up1 === 0) channels[ch].p1++;
                if (row[C.P2]) channels[ch].p2++;
                if (up2 > 0) channels[ch].upP2++;
                channels[ch].revenue += rev;

                const cats = String(row[C.CATEGORIES] || '').split(',').map(s => s.trim()).filter(s => s && s !== '999');
                cats.forEach(cat => {
                    if (!categories[cat]) categories[cat] = { name: cat, total: 0, p1Rev: 0, up1Rev: 0, up2Rev: 0, p1B: 0, up1B: 0, up2B: 0 };
                    categories[cat].total += rev / (cats.length || 1);
                    categories[cat].p1Rev += p1 / (cats.length || 1);
                    categories[cat].up1Rev += up1 / (cats.length || 1);
                    categories[cat].up2Rev += up2 / (cats.length || 1);
                    if (p1 > 0) categories[cat].p1B++;
                    if (up1 > 0) categories[cat].up1B++;
                    if (up2 > 0) categories[cat].up2B++;
                });
            }
        });
        return { summary, channels, categories: Object.values(categories) };
    }

    function showCategoryDetails(categoryName) {
        const C = CONFIG.COLUMN_NAMES;
        const start = new Date(document.getElementById('startDate').value);
        const end = new Date(document.getElementById('endDate').value);
        end.setHours(23, 59, 59);

        const filtered = allDataCache.filter(r => {
            const d = parseGvizDate(r[C.DATE]);
            const rowCats = String(r[C.CATEGORIES] || '').split(',').map(s => s.trim());
            return d >= start && d <= end && rowCats.includes(categoryName);
        });

        const groups = {
            p1: filtered.filter(r => toNumber(r[C.P1]) > 0 && toNumber(r[C.UP_P1]) === 0),
            up1: filtered.filter(r => toNumber(r[C.UP_P1]) > 0),
            up2: filtered.filter(r => toNumber(r[C.UP_P2]) > 0)
        };

        document.getElementById('modalTitle').children[0].textContent = `‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ${categoryName}`;
        
        let html = '';
        
        // 1. Render Table for P1
        if (groups.p1.length > 0) {
            html += `
                <div class="type-section">
                    <div class="type-title">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏• P1 <span class="type-badge">${groups.p1.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à</th><th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (P1)</th></tr></thead>
                            <tbody>
                                ${groups.p1.map(r => `
                                    <tr>
                                        <td>${formatDate(parseGvizDate(r[C.DATE]))}</td>
                                        <td>${r[C.CUSTOMER] || '-'}</td>
                                        <td><small>${r[C.INTEREST] || '-'}</small></td>
                                        <td class="revenue-cell">‡∏ø${toNumber(r[C.P1]).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        }

        // 2. Render Table for UP P1 (‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏à‡∏≤‡∏Å P1) - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏¥‡∏° P1 ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
        if (groups.up1.length > 0) {
            html += `
                <div class="type-section">
                    <div class="type-title">üöÄ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏• UP P1 (‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏à‡∏≤‡∏Å P1) <span class="type-badge">${groups.up1.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡πÉ‡∏à (P1) + ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ UP</th><th>‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏¥‡∏° P1 (‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤)</th><th>‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î (UP P1)</th></tr></thead>
                            <tbody>
                                ${groups.up1.map(r => {
                                    const custName = String(r[C.CUSTOMER] || '').trim();
                                    const custPhone = String(r[C.PHONE] || '').trim();
                                    
                                    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡∏≠‡∏î P1 ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                    const history = allDataCache.find(h => {
                                        const hName = String(h[C.CUSTOMER] || '').trim();
                                        const hPhone = String(h[C.PHONE] || '').trim();
                                        const isSameUser = (custPhone && hPhone === custPhone) || (hName === custName);
                                        // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ P1 ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÅ‡∏Ñ‡πà‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î
                                        return isSameUser && toNumber(h[C.P1]) > 0;
                                    });

                                    const p1Val = history ? toNumber(history[C.P1]) : toNumber(r[C.P1]);
                                    const p1Interest = history ? history[C.INTEREST] : (r[C.INTEREST] || '-');

                                    return `
                                    <tr>
                                        <td>${formatDate(parseGvizDate(r[C.DATE]))}</td>
                                        <td>${r[C.CUSTOMER] || '-'}</td>
                                        <td>
                                            <span class="context-label">‡πÄ‡∏î‡∏¥‡∏°: ${p1Interest}</span>
                                            <small>UP: ${r[C.INTEREST] || '-'}</small>
                                        </td>
                                        <td class="context-cell" style="color: ${history ? '#00f2fe' : '#ff4757'}">‡∏ø${p1Val.toLocaleString()}</td>
                                        <td class="revenue-cell">‡∏ø${toNumber(r[C.UP_P1]).toLocaleString()}</td>
                                    </tr>
                                `;}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        }

        // 3. Render Table for UP P2
        if (groups.up2.length > 0) {
            html += `
                <div class="type-section">
                    <div class="type-title">üíé ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏• UP P2 (‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏à‡∏≤‡∏Å P2) <span class="type-badge">${groups.up2.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏≤‡∏Å P2 (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F)</th><th>‡∏¢‡∏≠‡∏î‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î (UP P2)</th></tr></thead>
                            <tbody>
                                ${groups.up2.map(r => {
                                    const custName = String(r[C.CUSTOMER] || '').trim();
                                    const custPhone = String(r[C.PHONE] || '').trim();
                                    
                                    const history = allDataCache.find(h => {
                                        const hName = String(h[C.CUSTOMER] || '').trim();
                                        const hPhone = String(h[C.PHONE] || '').trim();
                                        const isSameUser = (custPhone && hPhone === custPhone) || (hName === custName);
                                        const isP2Lead = h[C.P2] && String(h[C.P2]).trim() !== '';
                                        return isSameUser && isP2Lead && h[C.INTEREST];
                                    });

                                    const p2Interest = history ? history[C.INTEREST] : (r[C.INTEREST] || "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ P2 ‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F");

                                    return `
                                        <tr>
                                            <td>${formatDate(parseGvizDate(r[C.DATE]))}</td>
                                            <td>${r[C.CUSTOMER] || '-'}</td>
                                            <td><small>${r[C.INTEREST] || '-'}</small></td>
                                            <td class="context-cell" style="color: ${history ? '#00f2fe' : '#ff4757'}">${p2Interest}</td>
                                            <td class="revenue-cell">‡∏ø${toNumber(r[C.UP_P2]).toLocaleString()}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        }

        if (html === '') html = '<p style="text-align:center; padding: 20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';

        document.getElementById('modalBody').innerHTML = html;
        document.getElementById('detailsModal').classList.add('show');
    }

    function generateGeminiPrompt() {
        const d = latestData.current;
        const f = (n) => Math.round(n).toLocaleString();
        const branch = document.querySelector('h1').textContent.replace('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏™‡∏≤‡∏Ç‡∏≤', '').trim();
        
        let p = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏° ‡πÇ‡∏õ‡∏£‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:\n\n`;
        p += `--- [‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå] ---\n* ‡∏™‡∏≤‡∏Ç‡∏≤: ${branch}\n* ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${document.getElementById('startDate').value} ‡∏ñ‡∏∂‡∏á ${document.getElementById('endDate').value}\n\n`;
        p += `--- [‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô] ---\n* ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: ${f(d.summary.totalRevenue)} ‡∏ö‡∏≤‡∏ó\n* ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${f(d.summary.totalBills)} ‡∏ö‡∏¥‡∏•\n* ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ P1: ${f(d.summary.p1Revenue)} ‡∏ö‡∏≤‡∏ó\n* ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ UP P1: ${f(d.summary.upp1Revenue)} ‡∏ö‡∏≤‡∏ó\n* ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ UP P2: ${f(d.summary.upp2Revenue)} ‡∏ö‡∏≤‡∏ó\n\n`;

        const top5 = [...d.categories].sort((a,b) => b.total - a.total).slice(0, 5);
        p += `* 5 ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:\n` + top5.map(c => `  - ${c.name}: ${f(c.total)} ‡∏ö‡∏≤‡∏ó`).join('\n') + `\n\n`;

        const p1Top = [...d.categories].sort((a,b) => b.p1Rev - a.p1Rev).slice(0, 5).filter(c => c.p1Rev > 0);
        p += `* 5 ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà P1 ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:\n` + p1Top.map(c => `  - ${c.name}: ${f(c.p1Rev)} ‡∏ö‡∏≤‡∏ó (${c.p1B} ‡∏ö‡∏¥‡∏•)`).join('\n') + `\n\n`;

        const up1Top = [...d.categories].sort((a,b) => b.up1Rev - a.up1Rev).slice(0, 5).filter(c => c.up1Rev > 0);
        p += `* 5 ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà UP P1 ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:\n` + up1Top.map(c => `  - ${c.name}: ${f(c.up1Rev)} ‡∏ö‡∏≤‡∏ó (${c.up1B} ‡∏ö‡∏¥‡∏•)`).join('\n') + `\n\n`;

        const up2Top = [...d.categories].sort((a,b) => b.up2Rev - a.up2Rev).slice(0, 5).filter(c => c.up2Rev > 0);
        p += `* 5 ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà UP P2 ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:\n` + up2Top.map(c => `  - ${c.name}: ${f(c.up2Rev)} ‡∏ö‡∏≤‡∏ó (${c.up2B} ‡∏ö‡∏¥‡∏•)`).join('\n') + `\n\n`;

        p += `--- [‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á] ---\n`;
        Object.entries(d.channels).sort((a,b) => b[1].revenue - a[1].revenue).forEach(([name, val]) => {
            p += `* ${name}: ‡∏ö‡∏¥‡∏• P1 ${val.p1}, P2 Leads ${val.p2}, ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ${f(val.revenue)} ‡∏ö‡∏≤‡∏ó\n`;
        });

        p += `\n--- [‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á] ---\n‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á ‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (Action Plan) ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á`;
        return p;
    }

    async function updateDashboard() {
        document.getElementById('loading').classList.add('show');
        await fetchData();
        const start = new Date(document.getElementById('startDate').value);
        const end = new Date(document.getElementById('endDate').value);
        end.setHours(23, 59, 59);

        const currentRows = allDataCache.filter(r => {
            const d = parseGvizDate(r[CONFIG.COLUMN_NAMES.DATE]);
            return d >= start && d <= end;
        });

        const current = processPeriod(currentRows);
        latestData = { current };

        document.getElementById('mainStatsGrid').innerHTML = `
            <div class="stat-card"><div class="stat-number">${current.summary.totalBills}</div><div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
            <div class="stat-card"><div class="stat-number">‡∏ø${Math.round(current.summary.totalRevenue).toLocaleString()}</div><div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div></div>
            <div class="stat-card"><div class="stat-number">${current.summary.totalCustomers}</div><div class="stat-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
        `;

        document.getElementById('revenueStatsGrid').innerHTML = `
            <div class="stat-card"><div class="stat-number">‡∏ø${Math.round(current.summary.p1Revenue).toLocaleString()}</div><div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ P1</div></div>
            <div class="stat-card"><div class="stat-number">‡∏ø${Math.round(current.summary.upp1Revenue).toLocaleString()}</div><div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ UP P1</div></div>
            <div class="stat-card"><div class="stat-number">‡∏ø${Math.round(current.summary.upp2Revenue).toLocaleString()}</div><div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ UP P2</div></div>
        `;

        document.getElementById('channelTableBody').innerHTML = Object.entries(current.channels).sort((a,b) => b[1].revenue - a[1].revenue).map(([name, val]) => `
            <tr><td><strong>${name}</strong></td><td>${val.p1}</td><td>${val.p2}</td><td>${val.upP2}</td><td class="revenue-cell">‡∏ø${Math.round(val.revenue).toLocaleString()}</td></tr>
        `).join('');

        const sortedCats = current.categories.sort((a,b) => b.total - a.total);
        document.getElementById('categoryTableBody').innerHTML = sortedCats.map((c, i) => `
            <tr class="clickable-row" onclick="showCategoryDetails('${c.name.replace(/'/g, "\\'")}')">
                <td>${i+1}</td><td><strong>${c.name}</strong></td><td>${c.p1B}</td><td>${c.up1B}</td><td>${c.up2B}</td><td class="revenue-cell">‡∏ø${Math.round(c.total).toLocaleString()}</td>
            </tr>
        `).join('');

        updateCharts(sortedCats);
        document.getElementById('loading').classList.remove('show');
    }

    function updateCharts(cats) {
        const ctx = document.getElementById('revenueBarChart').getContext('2d');
        if (charts.bar) charts.bar.destroy();
        charts.bar = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: cats.slice(0, 10).map(c => c.name),
                datasets: [{ 
                    label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏ø)', 
                    data: cats.slice(0, 10).map(c => c.total), 
                    backgroundColor: '#00f2fe', 
                    borderRadius: 5 
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    y: { 
                        ticks: { color: '#a0a0b0' }, 
                        grid: { color: 'rgba(255,255,255,0.1)' } 
                    }, 
                    x: { ticks: { color: '#a0a0b0' } } 
                },
                plugins: {
                    legend: { labels: { color: '#f0f0f0' } }
                }
            }
        });
    }

    document.getElementById('refreshBtn').onclick = updateDashboard;
    document.getElementById('geminiBtn').onclick = () => {
        const prompt = generateGeminiPrompt();
        document.getElementById('modalTitle').children[0].textContent = 'ü§ñ Prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Gemini';
        document.getElementById('modalBody').innerHTML = `<textarea readonly id="geminiPromptText">${prompt}</textarea><br><button class="btn" onclick="copyPrompt()">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>`;
        document.getElementById('detailsModal').classList.add('show');
    };

    window.copyPrompt = () => {
        const txt = document.getElementById('geminiPromptText');
        txt.select();
        document.execCommand('copy');
        const btn = event.target;
        btn.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
        setTimeout(() => btn.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°', 2000);
    };

    window.onclick = function(event) {
        const modal = document.getElementById('detailsModal');
        if (event.target == modal) {
            modal.classList.remove('show');
        }
    }

    const now = new Date();
    document.getElementById('endDate').value = now.toISOString().split('T')[0];
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    document.getElementById('startDate').value = startOfMonth.toISOString().split('T')[0];
    
    updateDashboard();
    </script>
</body>
</html>
